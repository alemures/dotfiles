#!/usr/bin/env node

const os = require('os');
const utils = require('./utils');

/**
 * @param {string} device
 * @returns
 */
function parseDevice(device) {
  const splittedDevice = device.split(' ');
  return {
    name: splittedDevice[0],
    type: splittedDevice[1],
    size: splittedDevice[2],
    mountpoint: splittedDevice[3] || undefined,
  };
}

const lsblkResult = utils.run({
  command: 'lsblk',
  args: ['-rpo', 'name,type,size,mountpoint'],
});

const devices = lsblkResult.stdout
  .trim()
  .split(os.EOL)
  .filter((line) => line.includes('part') || line.includes('rom'));

const deviceNames = devices.map((deviceInfo) => deviceInfo.split(' ')[0]);

const dmenuResult = utils.run({
  command: 'dmenu',
  args: ['-i', '-l', '20', '-p', 'Mount/Umount partition:'],
  options: { input: devices.join(os.EOL), silentExit: true },
});

const parsedDevice = parseDevice(dmenuResult.stdout.trim());
if (!deviceNames.includes(parsedDevice.name))
  throw new Error('Invalid block device');

console.log(parsedDevice);

if (parsedDevice.mountpoint) {
  // TODO: umount
} else {
  // TODO: mount
}
